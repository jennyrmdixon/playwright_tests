name: Playwright Tests
run-name: >
  Playwright ${{ github.event.inputs.runType || 'push' }} - ${{ github.ref_name }} - ${{ github.event.head_commit.message || github.sha }}


on:
  push:
    branches: [ master ]

  workflow_dispatch:
      inputs:
        runType:
          description: 'Type of run'
          required: true
          default: 'fullSuite'
          type: choice
          options:
            - fullSuite
            - repeatE2E
        repeatE2E: 
          description: 'Number of times to run repeatE2E'
          required: false
          default: '5'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run all tests 
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.runType == 'fullSuite') }}
        run: npx playwright test

      - name: Upload full run report
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() && (github.event_name == 'push' || github.event_name == 'workflow_dispatch' && github.event.inputs.runType == 'fullSuite') }}
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
      
      - name: Run E2E test 
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.runType == 'repeatE2E' }}
        run: |
          npx playwright test tests/end_to_end.spec.ts --repeat-each=${{ github.event.inputs.repeatE2E }}

      - name: Upload E2E report 
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() && github.event.inputs.runType == 'repeatE2E' }}
        with:
          name: e2e-report-html
          path: playwright-report/
          retention-days: 30
      
      - name: Upload E2E report video
        uses: actions/upload-artifact@v4
        if: ${{ !cancelled() && github.event.inputs.runType == 'repeatE2E' }}
        with:
          name: e2e-report-video
          path: data
          retention-days: 30

      - name: Package report and results
        if: ${{ !cancelled() && github.event.inputs.runType == 'repeatE2E' }}
        run: |
          zip -r combined-report.zip playwright-report data

      - name: Upload combined report
        uses: actions/upload-artifact@v4
        with:
          name: full-playwright-report
          path: combined-report.zip

          